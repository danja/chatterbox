## Chatterbox Design Notes

The target is something comparable to the original [Chatterbox](https://github.com/danja/chatterbox/blob/master/reference/Chatterbox-1976.pdf) but based on a microcontroller and with HTTP and MIDI interfaces.

There are a lot of unknowns so a lot of experimentation is needed and **everything here is provisional**. Current status will be in [quasi-blog notes.md](https://github.com/danja/chatterbox/blob/master/notes.md).

**[Overview](#overview)**
* [Generators](#generators)
* [Filters](#filter)

**[Software Implementation](#software-implementation)**
* [Parameters](#parameters)


### Overview

![Chatterbox Block Diagram v1](https://github.com/danja/chatterbox/blob/master/media/block-diagram_v1.png "Chatterbox Block Diagram")

#### Generators
 * Wavetable - approximating waveform generated by larynx for voiced sounds
 * Noise - pseudo-random source, for fricatives, sibilants etc.

#### Filters
 * F1 - (formant) 1 : bandpass, variable frequency
 * F2 - (formant) 2 : bandpass, variable frequency
 * F3 - filter 3 : high shelf, variable frequency & Q
 * SF1-SF3 : high pass filters, fixed parameters

#### Envelope Shapers
 * E0-E4 : simple fixed attack/sustain/decay-driven amplifiers, triggered by switches

#### Controls
 * S0 : voiced waveform (most speech)
 * S1 : aspiration waveform (whisper)
 * S2-S4 : unvoiced burst, fixed fricative/sibilant
 * P0 : formant 1 frequency
 * P1 : formant 2 frequency
 * P2 : filter 3 frequency
 * P3 : filter 3 Q
 * P4 : voiced waveform frequency
 * P5 : voiced waveform shape (corresponding to open/closed larynx timing)

As noted this is all **provisional**. Aside from the overall topology, a couple of specific open questions are :

* the best use of P2 & P3. It's probably a good thing the number of ADCs is limited, this part could be seriously open-ended (

### Software Implementation

*The code is very much in flux, I'll write up something once stable. For now, view /src*

I'm coding using the Arduino IDE. Standard libs + ESP32 extensions, plus playing with 3rd party generic C++ filter designs.

### Parameters

Values are needed for the various frequencies, Qs etc. The original Chatterbox provides what will hopefully be good starting points for most, with the help of a bit of literature-dredging.

#### Sample Rate

Klatt [1980] states that "most of the sound energy in speech is contained in frequencies between 80 and 8000Hz" (and goes on to say that intelligibility isn't much affected using 5kHz). So a sample rate of 16kHz+ is desirable.  

The DAC used here will comfortably support stereo 16 bit @ 44.1kHz, but to help pre-empt any potential performance issues I've provisionally gone for a sample rate of 22050, which should be plenty for speech. 

#### Fundamental Pitch

The Chatterbox article talks of a fundamental (laryngeal) pitch for male speech being about 20-250Hz, with a median of 100Hz. The implementation uses 20-200Hz.

Klatt & Klatt [1990] talks of female speech parameters being typically 1.7 * the frequency of male. Their implementation (KLSYN88) uses a range of 0-500Hz, typical 100Hz.

So here 0-500Hz seems reasonable. Some scaling of the potentiometer value to provide effective control will be desirable, probably a simple polynomial. (Note that at the extremes the ESP32's ADCs are very non-linear, this will probably need compensation too).

F_MIN = 0
F_MAX = 500

#### Variable Filters

These are the two formant filters F1, F2 and the 'auxiliary' F3. 

**Frequencies**

Chatterbox has the first formant at range required 300-750Hz (but calculated for filter implementation 180-550Hz). The second, 750-2250Hz (calculated 940-2850Hz). Noting that this is male voice only, to cover the female range the high ends can be scaled by 1.7, to 1275Hz and 3825Hz.

The Klatts' KLSYN88 has F1 = 180-1300Hz, typically 500, F2 = 550-3000Hz, typ. 1500.

Note that KLSYN88 includes 5 formant filters for voiced sounds, the highest going from 3000-4990Hz typ. 3700 (there is an F6 for fricative sounds only,  3000-4990Hz, typ. 4990Hz).

So a first trial here of F1 = 150-1400Hz, F2 = 500-5000Hz seems reasonable.

F3 functionality is really something to decide later, but to avoid significant interference with F1 & F2, a freq. range of 50-7000Hz should make a reasonable starting range.

F_MIN = 0
F_MAX = 500

**Bandwidth**

The original Chatterbox implements F1 bandwidth 110Hz, F2 bandwidth 160Hz, but mentions published values 50-100Hz, opting for the higher values to avoid instability.

KLATTSYN88 has F1 bandwidth range 30-1000Hz, typ. 60Hz, and F2 40-1000Hz, typ. 90Hz.

F1 & F2 have fixed bandwidth here, so a first guess of F1 : 50Hz and F2 : 100Hz seems reasonable.

F3, again to be decided so probably best to keep out of the way for now. It is variable. Give it a min. bandwidth of 200Hz.

**Q**

Q = f/bandwidth ([Wikipedia](https://en.wikipedia.org/wiki/Q_factor#Relationship_between_Q_and_bandwidth))

Assuming the following typical freq. values, F1 = 500Hz, F2 = 1500Hz, F3 = 1000Hz. Bandwidth 50Hz, 100Hz, 200Hz.

F1_Q = 10
F2_Q = 15
F3_Q (max) = 5

*Those all seem very high...*

#### Fixed Filters

These are the initial filters for sibilant/fricative sounds.

For now, taking values around those of original Chatterbox.

**SF1** (sh) : frequency 2100Hz bandwidth 200Hz 
**SF2** (ff) : frequency 3700Hz bandwidth 300Hz 
**SF3** (sh) : frequency 5600Hz bandwidth 400Hz 

F_MIN = 0
F_MAX = 500

F1_LOW = 150
F1_HIGH = 1400
F2_LOW = 500
F2_HIGH = 5000
F3_LOW = 50
F3_HIGH = 7000

F1_Q = 10
F2_Q = 15
F3_Q (max) = 5

SF1_F = 2100
SF2_F = 3700
SF3_F = 5600

SF1_Q = 10
SF2_Q = 12
SF3_Q = 14

**Notes**
Chances are the relationship between Q and frequency of speech formants is fixed as assumed above. Experimentation and more research required to see if some kind of tracking may be beneficial.

It might be desirable to implement additional filters combined with F1, F2, F3 with frequencies locked to multiples of their centre frequencies, ie. harmonics. 

The Chatterbox article notes that the fricative sounds have different amplitudes, 'fff' being much weaker. This should be easy to sort out later.

### External Interfaces

#### Web Interface

Two approaches will be targetted: real-time and batch.

**Real Time Control**

A browser-based controller will be implemented, with dynamic components approximating those of the hardware. Change to these will be pushed to the Chatterbox in real time, overriding the (individual) hardware controls there.

Similarly, changes to the hardware controller settings will be pushed to the browser, overrriding the existing settings there.

WebSockets seems the easiest approach.

**Batch Control**

It will be desirable to send a sequence of controller instructions from an external client to the Chatterbox. Implementation remains TBD, but a possibility is to HTTP POST a sequence of controller settings (with timing information) and have the Chatterbox run these on a minimal internal sequencer.

#### MIDI

There are (at least) 3 options here: MIDI-over-USB, MIDI BLE (Bluetooth) and traditional wired. For the forseeable future, only the wired version will be implemented for both MIDI in and out. The external hardware is trivial, it should be possible to use UART 0 or 2 (pins are free).

Pitch can be hooked up to standard MIDI pitch & bend controllers, there are probably conventions for analog synths that can inform which controllers to assign to the noise and filter functionality.

### Hardware Implementation

The core of the system is an ESP32 system-on-a-chip with external UDA1334A DAC.

I'm using modules sourced from Banggood, China : [ESP32 Development Board WiFi+bluetooth Ultra Low Power Consumption Dual Cores ESP-32 ESP-32S Board Geekcreit](https://www.banggood.com/ESP32-Development-Board-WiFibluetooth-Ultra-Low-Power-Consumption-Dual-Cores-ESP-32-ESP-32S-Board-p-1109512.html) which I believe is the same as "ESP32 DEVKIT V1 - DOIT version with 36 GPIOs", and [CJMCU-1334 UDA1334A I2S Audio Stereo Decoder Module Board](https://www.banggood.com/CJMCU-1334-UDA1334A-I2S-Audio-Stereo-Decoder-Module-Board-3_3V-5V-p-1296295.html) which appears to be common across many other suppliers. (Banggood are inexpensive, at the cost of delivery time).

Simple push switches are used for S0-S4, used to trigger/maintain sounds.

*The original Chatterbox used touch switches and coincidentally the ESP32 has built-in support for capacit

P0 & P1 are the X & Y axes of an analog (potentiometer) joystick (I got mine from [Banggood](https://www.banggood.com/Joystick-potentiometer-JH-D202X-R2R4-10K-2D-Monitor-Keyboard-ball-controller-For-Photographic-Film-p-1144188.html)).

P2-P4 are 100k lin potentiometers.

First prototype hardware looks like this:

![Breadboard spaghetti](https://github.com/danja/chatterbox/blob/master/media/prototype1-hardware-breadboard.jpg "Breadboard spaghetti")

Just an ESP32 module and a UDA1334A, lots of spaghetti. 

*Yeah, for now all dumped on a breadboard. Will probably put on stripboard later.*

![Control Panel](https://github.com/danja/chatterbox/blob/master/media/prototype1-hardware-case.jpg "Control Panel")

For a first prototype I've mounted everything on some pieces of thin acrylic I had handy. Once I've decided final controllers etc, will look for something more substantial. I pretty much guessed what I'd be likely to need, based on the original Chatterbox hardware.

* Loudspeaker - I haven't made an amplifier for it yet, will probably use an LM386 or LM380 (and add line out). Currently monitoring with cheap computer speakers.
* Power switch & LED. I don't know yet what kind of PSU will be best - external 9v block or custom split rail for op amps, if I add some analog bits.
* Analog joystick. Rather pricey, but essential IMHO.
* Switches - simple single-pole push. The inputs have ESP32-internal pulldown resistors, the switches all have one terminal to +3.3v, the other to the appropriate GPIO terminal.
* Potentiometers. I hadn't realised I'd be limited to 6 ADCs on the ESP32 so only the joystick and the 4 pots on the right are wired this way (as potential dividers, 3.3v to one terminal, 0v to the other, middle to the ADC in).

I had allowed for one pot for volume control but effectively had the one in the middle left over. But it has occured to me that I can produce a different output on DAC channel 2 (say something from further up the filter chain), direct this passively through the extra control.

----

**DAC Wiring**

**ESP32	DAC**

D26     BLCK

D27     DIN

D25     WSEL

100R in between

[reference](https://randomnerdtutorials.com/esp32-pinout-reference-gpios/)


----
**Double-check connections**

[ESP32 Pinout Reference: Which GPIO pins should you use?](https://randomnerdtutorials.com/esp32-pinout-reference-gpios/)

ESP32
// {19, 23, 12, 13, 14,    17, 18, 5,     16, 15, 2, 4};
pin 5 needed 10k pulldown

Pin
1 EN - 100n -> GND
2 GPIO 36 ADC -> JOYSTICK X f1f
3 GPIO 39 ADC -> JOYSTICK Y f2f
4 GPOI 34 ADC -> POT larynx
5 GPOI 35 ADC -> POT pitch
6 GPOI 32 ADC -> POT f3f
7 GPOI 33 ADC -> POT f3q
8 GPOI 25 DIGITAL -> 100R -> DAC WSEL
9 GPOI 26 DIGITAL -> 100R -> DAC BLCK
10 GPOI 27 DIGITAL 100R -> -> DAC DIN
11 GPOI 14 DIGITAL -> SWITCH aspirated
12 GPOI 12 DIGITAL -> SWITCH sf3
13 GPOI 13 DIGITAL -> SWITCH voiced
14 GPOI 9 (unavailable)
15 GPOI 10 (unavailable)
16 GPOI 11 (unavailable)
17 GND
18 VIN

19 GPOI 3V3
20 GPOI 6 (unavailable)
21 GPOI 7 (unavailable)
22 GPOI 8 (unavailable)
23 GPOI 0 (limited use)
24 GPOI 15 DIGITAL -> TOGGLE T1
25 GPOI 2 DIGITAL -> TOGGLE T2
26 GPOI 4 DIGITAL -> TOGGLE T4
27 GPOI 16 [UART 2 TX] DIGITAL -> TOGGLE T0
28 GPOI 17 [UART 2 RX] DIGITAL -> SWITCH x5
29 GPOI 5 DIGITAL -> SWITCH x7 (needed 10k pulldown resistor)
30 GPOI 18 DIGITAL -> SWITCH x6
31 GPOI 19 DIGITAL -> SWITCH sf1
32 GPOI 21 [I2C SDA]  ...(((DISPLAY?)))
33 GPOI 3 [UART 0 RX] ...(((MIDI IN)))
34 GPOI 1 [UART 0 TX] ...(((MIDI OUT)))
35 GPOI 22 [I2C SCL] ...(((DISPLAY?)))
36 GPOI 23 DIGITAL -> SWITCH sf2

## Initial Considerations

These were notes I had in README.md. After some experimentation I can answer them all, very positively.

* The 12-bit ADCs of the ESP32 should be adequate for analog input from joystick & a few pots. Hopefully, given an external DAC, 16 bit output signal shouldn't be too demanding. 

The limits on the number of ADCs threw me a bit, but turned out to be just adequate. Once I'd seen the price (4.18 euro), the external DAC was a no-brainer.

* A potential issue is performance on the ESP32. The 7kHz @ 44.1kHz sine I got out of the box was generated using floats with minimal arithmetic. The original Chatterbox employed 5 formant filters, the computational demand of those (plus sound generation, interface recognition) might get heavy. 

The 7kHz was a false reading. The thing doesn't appear to have had any performance issues so far, using float arithmetic.

* Plan B is to use fixed-point arithmetic for the DSP calculations. Potentially orders of magnitude speed increase in speed of calculations, at the cost of spending lots of time figuring it all out.

Almost certainly unnecessary.

* Plan C is to use an Arduino Due, considerably faster than the ESP32 but with expense, leaning to the point of might-as-well-use-a-Raspberry Pi.

I bought a Due anyway, that will probably become a different kind of synth.

* Plan D is to drop all this, use a mobile phone, laptop. And/or, game handset.

So far so good, though the other plans might be worth visiting in future.







