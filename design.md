## Chatterbox Design Notes

The target is something comparable to the original [Chatterbox](https://github.com/danja/chatterbox/blob/master/reference/Chatterbox-1976.pdf) but based on a microcontroller and (ultimately) with HTTP-access and MIDI interfaces.

There are a lot of unknowns so a lot of experimentation is needed and **everything here is provisional**. Current status will be in [quasi-blog notes.md](https://github.com/danja/chatterbox/blob/master/notes.md).

![Chatterbox Block Diagram v1](https://github.com/danja/chatterbox/blob/master/media/block-diagram_v1.png "Chatterbox Block Diagram")

### Generators
 * Wavetable - approximating waveform generated by larynx for voiced sounds
 * Noise - pseudo-random source, for fricatives, sibilants etc.

### Filters
 * F1 - (formant) 1 : bandpass, variable frequency
 * F2 - (formant) 2 : bandpass, variable frequency
 * F3 - filter 3 : high shelf, variable frequency & Q
 * SF1-SF3 : high pass filters, fixed parameters

### Envelope Shapers
 * E0-E4 : simple fixed attack/sustain/decay-driven amplifiers, triggered by switches

### Controls
 * S0 : voiced waveform (most speech)
 * S1 : aspiration waveform (whisper)
 * S2-S4 : unvoiced burst, fixed fricative/sibilant
 * P0 : formant 1 frequency
 * P1 : formant 2 frequency
 * P2 : filter 3 frequency
 * P3 : filter 3 Q
 * P4 : voiced waveform frequency
 * P5 : voiced waveform shape (corresponding to open/closed larynx timing)

As noted this is all **provisional**. Aside from the overall topology, a couple of specific open questions are :

* the best use of P2 & P3. It's probably a good thing the number of ADCs is limited, this part could be seriously open-ended (

### Software Implementation

*The code is very much in flux, I'll write up something once stable. For now, view /src*

I'm coding using the Arduino IDE. Standard libs + ESP32 extensions, plus playing with 3rd party generic C++ filter designs.

### Hardware Implementation

The core of the system is an ESP32 system-on-a-chip with external UDA1334A DAC.

I'm using modules sourced from Banggood, China : [ESP32 Development Board WiFi+bluetooth Ultra Low Power Consumption Dual Cores ESP-32 ESP-32S Board Geekcreit](https://www.banggood.com/ESP32-Development-Board-WiFibluetooth-Ultra-Low-Power-Consumption-Dual-Cores-ESP-32-ESP-32S-Board-p-1109512.html) which I believe is the same as "ESP32 DEVKIT V1 - DOIT version with 36 GPIOs", and [CJMCU-1334 UDA1334A I2S Audio Stereo Decoder Module Board](https://www.banggood.com/CJMCU-1334-UDA1334A-I2S-Audio-Stereo-Decoder-Module-Board-3_3V-5V-p-1296295.html) which appears to be common across many other suppliers. (Banggood are inexpensive, at the cost of delivery time).

Simple push switches are used for S0-S4, used to trigger/maintain sounds.

P0 & P1 are the X & Y axes of an analog (potentiometer) joystick (I got mine from [Banggood](https://www.banggood.com/Joystick-potentiometer-JH-D202X-R2R4-10K-2D-Monitor-Keyboard-ball-controller-For-Photographic-Film-p-1144188.html)).

P2-P4 are 100k lin potentiometers.

First prototype hardware looks like this:

![Breadboard spaghetti](https://github.com/danja/chatterbox/blob/master/media/prototype1-hardware-breadboard.jpg "Breadboard spaghetti")

Just an ESP32 module and a UDA1334A, lots of spaghetti. 

*Yeah, for now all dumped on a breadboard. Will probably put on stripboard later.*

![Control Panel](https://github.com/danja/chatterbox/blob/master/media/prototype1-hardware-case.jpg "Control Panel")

For a first prototype I've mounted everything on some pieces of thin acrylic I had handy. Once I've decided final controllers etc, will look for something more substantial. I pretty much guessed what I'd be likely to need, based on the original Chatterbox hardware.

* Loudspeaker - I haven't made an amplifier for it yet, will probably use an LM386 or LM380 (and add line out). Currently monitoring with cheap computer speakers.
* Power switch & LED. I don't know yet what kind of PSU will be best - external 9v block or custom split rail for op amps, if I add some analog bits.
* Analog joystick. Rather pricey, but essential IMHO.
* Switches - simple single-pole push. The inputs have ESP32-internal pulldown resistors, the switches all have one terminal to +3.3v, the other to the appropriate GPIO terminal.
* Potentiometers. I hadn't realised I'd be limited to 6 ADCs on the ESP32 so only the joystick and the 4 pots on the right are wired this way (as potential dividers, 3.3v to one terminal, 0v to the other, middle to the ADC in).

I had allowed for one pot for volume control but effectively had the one in the middle left over. But it has occured to me that I can produce a different output on DAC channel 2 (say something from further up the filter chain), direct this passively through the extra control.

## Initial Considerations

These were notes I had in README.md. After some experimentation I can answer them all, very positively.

* The 12-bit ADCs of the ESP32 should be adequate for analog input from joystick & a few pots. Hopefully, given an external DAC, 16 bit output signal shouldn't be too demanding. 

The limits on the number of ADCs threw me a bit, but turned out to be just adequate. Once I'd seen the price (4.18 euro), the external DAC was a no-brainer.

* A potential issue is performance on the ESP32. The 7kHz @ 44.1kHz sine I got out of the box was generated using floats with minimal arithmetic. The original Chatterbox employed 5 formant filters, the computational demand of those (plus sound generation, interface recognition) might get heavy. 

The 7kHz was a false reading. The thing doesn't appear to have had any performance issues so far, using float arithmetic.

* Plan B is to use fixed-point arithmetic for the DSP calculations. Potentially orders of magnitude speed increase in speed of calculations, at the cost of spending lots of time figuring it all out.

Almost certainly unnecessary.

* Plan C is to use an Arduino Due, considerably faster than the ESP32 but with expense, leaning to the point of might-as-well-use-a-Raspberry Pi.

I bought a Due anyway, that will probably become a different kind of synth.

* Plan D is to drop all this, use a mobile phone, laptop. And/or, game handset.

So far so good, though the other plans might be worth visiting in future.







